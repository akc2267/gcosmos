From d7752597676ee0cfc0fac2a2fae236af7edc9832 Mon Sep 17 00:00:00 2001
From: Mark Rushakoff <mark@strange.love>
Date: Wed, 17 Jul 2024 10:03:22 -0400
Subject: [PATCH 1/6] chore: allow injecting a server component into simd root
 command

---
 simapp/v2/simdv2/cmd/commands.go | 10 +++-------
 simapp/v2/simdv2/cmd/root_di.go  | 23 +++++++++++++++++++++--
 2 files changed, 24 insertions(+), 9 deletions(-)

diff --git a/simapp/v2/simdv2/cmd/commands.go b/simapp/v2/simdv2/cmd/commands.go
index 916f4b2be9..c55ad96c77 100644
--- a/simapp/v2/simdv2/cmd/commands.go
+++ b/simapp/v2/simdv2/cmd/commands.go
@@ -15,7 +15,6 @@ import (
 	runtimev2 "cosmossdk.io/runtime/v2"
 	serverv2 "cosmossdk.io/server/v2"
 	"cosmossdk.io/server/v2/api/grpc"
-	"cosmossdk.io/server/v2/cometbft"
 	"cosmossdk.io/server/v2/store"
 	"cosmossdk.io/simapp/v2"
 	confixcmd "cosmossdk.io/tools/confix/cmd"
@@ -41,8 +40,9 @@ func newApp[T transaction.Tx](logger log.Logger, viper *viper.Viper) serverv2.Ap
 
 func initRootCmd[T transaction.Tx](
 	rootCmd *cobra.Command,
-	txConfig client.TxConfig,
+	clientCtx client.Context,
 	moduleManager *runtimev2.MM[T],
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
 ) {
 	cfg := sdk.GetConfig()
 	cfg.Seal()
@@ -74,11 +74,7 @@ func initRootCmd[T transaction.Tx](
 		newApp,
 		logger,
 		initServerConfig(),
-		cometbft.New(
-			&genericTxDecoder[T]{txConfig},
-			initCometOptions[T](),
-			initCometConfig(),
-		),
+		makeComponent(clientCtx),
 		grpc.New[T](),
 		store.New[T](newApp),
 	); err != nil {
diff --git a/simapp/v2/simdv2/cmd/root_di.go b/simapp/v2/simdv2/cmd/root_di.go
index 1ad834b53a..f9464d9cd0 100644
--- a/simapp/v2/simdv2/cmd/root_di.go
+++ b/simapp/v2/simdv2/cmd/root_di.go
@@ -13,6 +13,8 @@ import (
 	"cosmossdk.io/depinject"
 	"cosmossdk.io/log"
 	"cosmossdk.io/runtime/v2"
+	serverv2 "cosmossdk.io/server/v2"
+	"cosmossdk.io/server/v2/cometbft"
 	"cosmossdk.io/simapp/v2"
 
 	"github.com/cosmos/cosmos-sdk/client"
@@ -26,8 +28,26 @@ import (
 	"github.com/cosmos/cosmos-sdk/x/auth/types"
 )
 
+func NewRootCmdWithServer[T transaction.Tx](
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
+) *cobra.Command {
+	return newRootCmd[T](makeComponent)
+}
+
 // NewRootCmd creates a new root command for simd. It is called once in the main function.
 func NewRootCmd[T transaction.Tx]() *cobra.Command {
+	return NewRootCmdWithServer(func(cc client.Context) serverv2.ServerComponent[T] {
+		return cometbft.New[T](
+			&genericTxDecoder[T]{cc.TxConfig},
+			initCometOptions[T](),
+			initCometConfig(),
+		)
+	})
+}
+
+func newRootCmd[T transaction.Tx](
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
+) *cobra.Command {
 	var (
 		autoCliOpts   autocli.AppOptions
 		moduleManager *runtime.MM[T]
@@ -83,12 +103,11 @@ func NewRootCmd[T transaction.Tx]() *cobra.Command {
 		},
 	}
 
-	initRootCmd(rootCmd, clientCtx.TxConfig, moduleManager)
+	initRootCmd(rootCmd, clientCtx, moduleManager, makeComponent)
 
 	nodeCmds := nodeservice.NewNodeCommands()
 	autoCliOpts.ModuleOptions = make(map[string]*autocliv1.ModuleOptions)
 	autoCliOpts.ModuleOptions[nodeCmds.Name()] = nodeCmds.AutoCLIOptions()
-
 	if err := autoCliOpts.EnhanceRootCommand(rootCmd); err != nil {
 		panic(err)
 	}
-- 
2.44.0

