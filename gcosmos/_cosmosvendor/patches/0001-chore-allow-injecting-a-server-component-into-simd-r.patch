From 8a65914f3a70dd61169f460ee4e9ef99a441244e Mon Sep 17 00:00:00 2001
From: Mark Rushakoff <mark@strange.love>
Date: Wed, 17 Jul 2024 10:03:22 -0400
Subject: [PATCH 1/6] chore: allow injecting a server component into simd root
 command

---
 simapp/v2/simdv2/cmd/commands.go |  6 +++---
 simapp/v2/simdv2/cmd/root_di.go  | 22 ++++++++++++++++++++--
 2 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/simapp/v2/simdv2/cmd/commands.go b/simapp/v2/simdv2/cmd/commands.go
index 2e315c64a1..5c155dfa77 100644
--- a/simapp/v2/simdv2/cmd/commands.go
+++ b/simapp/v2/simdv2/cmd/commands.go
@@ -15,7 +15,6 @@ import (
 	runtimev2 "cosmossdk.io/runtime/v2"
 	serverv2 "cosmossdk.io/server/v2"
 	"cosmossdk.io/server/v2/api/grpc"
-	"cosmossdk.io/server/v2/cometbft"
 	"cosmossdk.io/server/v2/store"
 	"cosmossdk.io/simapp/v2"
 	confixcmd "cosmossdk.io/tools/confix/cmd"
@@ -45,8 +44,9 @@ func newApp[T transaction.Tx](
 
 func initRootCmd[T transaction.Tx](
 	rootCmd *cobra.Command,
-	txConfig client.TxConfig,
+	clientCtx client.Context,
 	moduleManager *runtimev2.MM[T],
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
 ) {
 	cfg := sdk.GetConfig()
 	cfg.Seal()
@@ -78,7 +78,7 @@ func initRootCmd[T transaction.Tx](
 		newApp,
 		logger,
 		initServerConfig(),
-		cometbft.New(&genericTxDecoder[T]{txConfig}, cometbft.DefaultServerOptions[T]()),
+		makeComponent(clientCtx),
 		grpc.New[T](),
 		store.New[T](newApp),
 	); err != nil {
diff --git a/simapp/v2/simdv2/cmd/root_di.go b/simapp/v2/simdv2/cmd/root_di.go
index fd5b62b938..a8c443fe44 100644
--- a/simapp/v2/simdv2/cmd/root_di.go
+++ b/simapp/v2/simdv2/cmd/root_di.go
@@ -13,6 +13,8 @@ import (
 	"cosmossdk.io/depinject"
 	"cosmossdk.io/log"
 	"cosmossdk.io/runtime/v2"
+	serverv2 "cosmossdk.io/server/v2"
+	"cosmossdk.io/server/v2/cometbft"
 	"cosmossdk.io/simapp/v2"
 
 	"github.com/cosmos/cosmos-sdk/client"
@@ -26,8 +28,25 @@ import (
 	"github.com/cosmos/cosmos-sdk/x/auth/types"
 )
 
+func NewRootCmdWithServer[T transaction.Tx](
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
+) *cobra.Command {
+	return newRootCmd[T](makeComponent)
+}
+
 // NewRootCmd creates a new root command for simd. It is called once in the main function.
 func NewRootCmd[T transaction.Tx]() *cobra.Command {
+	return NewRootCmdWithServer(func(cc client.Context) serverv2.ServerComponent[T] {
+		return cometbft.New[T](
+			&genericTxDecoder[T]{cc.TxConfig},
+			cometbft.DefaultServerOptions[T](),
+		)
+	})
+}
+
+func newRootCmd[T transaction.Tx](
+	makeComponent func(cc client.Context) serverv2.ServerComponent[T],
+) *cobra.Command {
 	var (
 		autoCliOpts   autocli.AppOptions
 		moduleManager *runtime.MM[T]
@@ -82,12 +101,11 @@ func NewRootCmd[T transaction.Tx]() *cobra.Command {
 		},
 	}
 
-	initRootCmd(rootCmd, clientCtx.TxConfig, moduleManager)
+	initRootCmd(rootCmd, clientCtx, moduleManager, makeComponent)
 
 	nodeCmds := nodeservice.NewNodeCommands()
 	autoCliOpts.ModuleOptions = make(map[string]*autocliv1.ModuleOptions)
 	autoCliOpts.ModuleOptions[nodeCmds.Name()] = nodeCmds.AutoCLIOptions()
-
 	if err := autoCliOpts.EnhanceRootCommand(rootCmd); err != nil {
 		panic(err)
 	}
-- 
2.44.0

